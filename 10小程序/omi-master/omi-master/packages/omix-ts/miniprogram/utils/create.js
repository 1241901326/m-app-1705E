"use strict";
/*!
 *  omix v2.0.0 by dntzhang
 *  Github: https://github.com/Tencent/omi
 *  MIT Licensed.
*/
Object.defineProperty(exports, "__esModule", { value: true });
var obaa_1 = require("./obaa");
var path_1 = require("./path");
var ARRAYTYPE = '[object Array]';
var OBJECTTYPE = '[object Object]';
var FUNCTIONTYPE = '[object Function]';
var changes = [];
function create(store, option) {
    if (arguments.length === 2) {
        if (!store.instances) {
            store.instances = {};
        }
        if (!store.onChange) {
            store.onChange = function (fn) {
                changes.push(fn);
            };
        }
        if (!store.offChange) {
            store.offChange = function (fn) {
                for (var i = 0, len = changes.length; i < len; i++) {
                    if (changes[i] === fn) {
                        changes.splice(i, 1);
                        break;
                    }
                }
            };
        }
        getApp().globalData && (getApp().globalData.store = store);
        option.data = store.data;
        observeStore(store);
        var onLoad_1 = option.onLoad;
        option.onLoad = function (e) {
            this.store = store;
            option.use && (this.__updatePath = path_1.getPath(option.use));
            this.__use = option.use;
            store.instances[this.route] = [];
            store.instances[this.route].push(this);
            if (!option.data.___walked) {
                walk(this.store.data);
            }
            this.setData(option.data);
            var using = path_1.getUsing(store.data, option.use);
            using && this.setData(using);
            onLoad_1 && onLoad_1.call(this, e);
        };
        Page(option);
    }
    else {
        var ready_1 = (store.lifetimes && store.lifetimes.ready) || store.ready;
        store.lifetimes = store.lifetimes || {};
        store.ready = store.lifetimes.ready = function () {
            var page = getCurrentPages()[getCurrentPages().length - 1];
            store.use && (this.__updatePath = path_1.getPath(store.use));
            this.store = page.store;
            this.__use = store.use;
            store.data = this.store.data;
            this.setData(store.data);
            var using = path_1.getUsing(this.store.data, store.use);
            using && this.setData(using);
            this.store.instances[page.route].push(this);
            ready_1 && ready_1.call(this);
        };
        Component(store);
    }
}
function observeStore(store) {
    obaa_1.default(store.data, function (prop, value, old, path) {
        var patch = {};
        if (prop.indexOf('Array-push') === 0) {
            var dl = value.length - old.length;
            for (var i = 0; i < dl; i++) {
                patch[path_1.fixPath(path + '-' + (old.length + i))] = value[(old.length + i)];
            }
        }
        else if (prop.indexOf('Array-') === 0) {
            patch[path_1.fixPath(path)] = value;
        }
        else {
            patch[path_1.fixPath(path + '-' + prop)] = value;
        }
        _update(patch, store);
    });
}
function _update(kv, store) {
    for (var key in store.instances) {
        store.instances[key].forEach(function (ins) {
            if (store.updateAll || ins.__updatePath && path_1.needUpdate(kv, ins.__updatePath)) {
                ins.setData.call(ins, kv);
                var using = path_1.getUsing(store.data, ins.__use);
                using && ins.setData(using);
                updateStoreByFnProp(ins, store.data);
            }
        });
    }
    changes.forEach(function (change) {
        change(kv);
    });
    store.debug && storeChangeLogger(store, kv);
}
function storeChangeLogger(store, diffResult) {
    try {
        var preState = wx.getStorageSync("CurrentState") || {};
        var title = "State Changed";
        console.groupCollapsed("%c  " + title + " %c " + Object.keys(diffResult), 'color:#e0c184; font-weight: bold', 'color:#f0a139; font-weight: bold');
        console.log("%c    Pre State", 'color:#ff65af; font-weight: bold', preState);
        console.log("%c Change State", 'color:#3d91cf; font-weight: bold', diffResult);
        console.log("%c   Next State", 'color:#2c9f67; font-weight: bold', store.data);
        console.groupEnd();
        wx.setStorageSync("CurrentState", store.data);
    }
    catch (e) {
        console.log(e);
    }
}
function updateStoreByFnProp(ele, data) {
    if (data) {
        var patch = {};
        for (var key in data.__fnMapping) {
            patch[key] = data.__fnMapping[key].call(data);
        }
        ele.setData(patch);
    }
}
function getObjByPath(path, data) {
    var arr = path.replace(/]/g, '').replace(/\[/g, '.').split('.');
    var len = arr.length;
    if (len > 1) {
        var current = data[arr[0]];
        for (var i = 1; i < len - 1; i++) {
            current = current[arr[i]];
        }
        return { obj: current, key: arr[len - 1] };
    }
    else {
        return { obj: data, key: arr[0] };
    }
}
function walk(data) {
    data.___walked = true;
    Object.keys(data).forEach(function (key) {
        var obj = data[key];
        var tp = type(obj);
        if (tp == FUNCTIONTYPE) {
            setProp(key, obj, data);
        }
        else if (tp == OBJECTTYPE) {
            Object.keys(obj).forEach(function (subKey) {
                _walk(obj[subKey], key + '.' + subKey, data);
            });
        }
        else if (tp == ARRAYTYPE) {
            obj.forEach(function (item, index) {
                _walk(item, key + '[' + index + ']', data);
            });
        }
    });
}
function _walk(obj, path, data) {
    var tp = type(obj);
    if (tp == FUNCTIONTYPE) {
        setProp(path, obj, data);
    }
    else if (tp == OBJECTTYPE) {
        Object.keys(obj).forEach(function (subKey) {
            _walk(obj[subKey], path + '.' + subKey, data);
        });
    }
    else if (tp == ARRAYTYPE) {
        obj.forEach(function (item, index) {
            _walk(item, path + '[' + index + ']', data);
        });
    }
}
function setProp(path, fn, data) {
    var ok = getObjByPath(path, data);
    data.__fnMapping = data.__fnMapping || {};
    data.__fnMapping[path] = fn;
    Object.defineProperty(ok.obj, ok.key, {
        enumerable: true,
        get: function () {
            return fn.call(ok.obj);
        },
        set: function () {
            console.warn('Please using this.data.method to set method prop of data!');
        }
    });
}
function type(obj) {
    return Object.prototype.toString.call(obj);
}
function updateByFnProp(ele, data) {
    var patch = {};
    for (var key in data.__fnMapping) {
        patch[key] = data.__fnMapping[key].call(ele.oData);
    }
    ele.setData(patch);
}
create.obaa = obaa_1.default;
exports.default = create;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3JlYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztFQUlFOztBQUVGLCtCQUF5QjtBQUN6QiwrQkFBK0Q7QUFFL0QsSUFBTSxTQUFTLEdBQUcsZ0JBQWdCLENBQUE7QUFDbEMsSUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUE7QUFDcEMsSUFBTSxZQUFZLEdBQUcsbUJBQW1CLENBQUE7QUFNeEMsSUFBTSxPQUFPLEdBQThCLEVBQUUsQ0FBQTtBQWlKN0MsU0FBUyxNQUFNLENBQUMsS0FBNEIsRUFBRSxNQUFtQjtJQUMvRCxJQUFJLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQzFCLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFO1lBQ3BCLEtBQUssQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFBO1NBQ3JCO1FBRUQsSUFBRyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUM7WUFDakIsS0FBSyxDQUFDLFFBQVEsR0FBRyxVQUFTLEVBQXVCO2dCQUMvQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ2xCLENBQUMsQ0FBQTtTQUNGO1FBRUQsSUFBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUM7WUFDbEIsS0FBSyxDQUFDLFNBQVMsR0FBRyxVQUFTLEVBQXVCO2dCQUNoRCxLQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBQyxHQUFHLEdBQUUsT0FBTyxDQUFDLE1BQU0sRUFBQyxDQUFDLEdBQUMsR0FBRyxFQUFDLENBQUMsRUFBRSxFQUFDO29CQUMxQyxJQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUM7d0JBQ25CLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFBO3dCQUNwQixNQUFLO3FCQUNOO2lCQUNGO1lBQ0gsQ0FBQyxDQUFBO1NBQ0Y7UUFDRCxNQUFNLEVBQUUsQ0FBQyxVQUFV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RSxDQUFBO0lBQzNCLE1BQU0sQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxFQUFFO1FBQ3BDLFVBQVUsRUFBRSxJQUFJO1FBQ2hCLEdBQUcsRUFBRTtZQUNILE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDeEIsQ0FBQztRQUNELEdBQUcsRUFBRTtZQUNILE9BQU8sQ0FBQyxJQUFJLENBQUMsMkRBQTJELENBQUMsQ0FBQTtRQUMzRSxDQUFDO0tBQ0YsQ0FBQyxDQUFBO0FBR0osQ0FBQztBQUVELFNBQVMsSUFBSSxDQUFDLEdBQUc7SUFDZixPQUFPLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtBQUM1QyxDQUFDO0FBUUQsU0FBUyxjQUFjLENBQUMsR0FBRyxFQUFFLElBQUk7SUFDL0IsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFBO0lBQ2QsS0FBSyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1FBQ2hDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUE7S0FDbkQ7SUFDRCxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBQ3BCLENBQUM7QUFHRCxNQUFNLENBQUMsSUFBSSxHQUFHLGNBQUksQ0FBQTtBQUdsQixrQkFBZSxNQUFNLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiFcbiAqICBvbWl4IHYyLjAuMCBieSBkbnR6aGFuZ1xuICogIEdpdGh1YjogaHR0cHM6Ly9naXRodWIuY29tL1RlbmNlbnQvb21pXG4gKiAgTUlUIExpY2Vuc2VkLlxuKi9cblxuaW1wb3J0IG9iYWEgZnJvbSAnLi9vYmFhJ1xuaW1wb3J0IHsgZ2V0UGF0aCwgbmVlZFVwZGF0ZSwgZml4UGF0aCwgZ2V0VXNpbmcgfSBmcm9tICcuL3BhdGgnXG5cbmNvbnN0IEFSUkFZVFlQRSA9ICdbb2JqZWN0IEFycmF5XSdcbmNvbnN0IE9CSkVDVFRZUEUgPSAnW29iamVjdCBPYmplY3RdJ1xuY29uc3QgRlVOQ1RJT05UWVBFID0gJ1tvYmplY3QgRnVuY3Rpb25dJ1xuXG5pbnRlcmZhY2UgU3RvcmVDaGFuZ2VDYWxsYmFjayB7XG4gIChkZXRhaWw6IGFueSk6IHZvaWQ7XG59XG5cbmNvbnN0IGNoYW5nZXM6QXJyYXk8U3RvcmVDaGFuZ2VDYWxsYmFjaz4gPSBbXVxuXG5pbnRlcmZhY2UgSVBhZ2VTY3JvbGxPcHRpb24ge1xuICAvKiog6aG16Z2i5Zyo5Z6C55u05pa55ZCR5bey5rua5Yqo55qE6Led56a777yI5Y2V5L2NcHjvvIkgKi9cbiAgc2Nyb2xsVG9wOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBJVGFiSXRlbVRhcE9wdGlvbiB7XG4gIC8qKiDooqvngrnlh7t0YWJJdGVt55qE5bqP5Y+377yM5LuOMOW8gOWni++8jOacgOS9juWfuuehgOW6k++8miBgMS45LjBgICovXG4gIGluZGV4OiBzdHJpbmc7XG4gIC8qKiDooqvngrnlh7t0YWJJdGVt55qE6aG16Z2i6Lev5b6E77yM5pyA5L2O5Z+656GA5bqT77yaIGAxLjkuMGAgKi9cbiAgcGFnZVBhdGg6IHN0cmluZztcbiAgLyoqIOiiq+eCueWHu3RhYkl0ZW3nmoTmjInpkq7mloflrZfvvIzmnIDkvY7ln7rnoYDlupPvvJogYDEuOS4wYCAqL1xuICB0ZXh0OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJU2hhcmVBcHBNZXNzYWdlT3B0aW9uIHtcbiAgLyoqIOi9rOWPkeS6i+S7tuadpea6kOOAglxuICAgKlxuICAgKiDlj6/pgInlgLzvvJpcbiAgICogLSBgYnV0dG9uYO+8mumhtemdouWGhei9rOWPkeaMiemSru+8m1xuICAgKiAtIGBtZW51YO+8muWPs+S4iuinkui9rOWPkeiPnOWNleOAglxuICAgKlxuICAgKiDmnIDkvY7ln7rnoYDlupPvvJogYDEuMi40YFxuICAgKi9cbiAgZnJvbTogJ2J1dHRvbicgfCAnbWVudScgfCBzdHJpbmc7XG4gIC8qKiDlpoLmnpwgYGZyb21gIOWAvOaYryBgYnV0dG9uYO+8jOWImSBgdGFyZ2V0YCDmmK/op6blj5Hov5nmrKHovazlj5Hkuovku7bnmoQgYGJ1dHRvbmDvvIzlkKbliJnkuLogYHVuZGVmaW5lZGBcbiAgICpcbiAgICog5pyA5L2O5Z+656GA5bqT77yaIGAxLjIuNGAgKi9cbiAgdGFyZ2V0OiBhbnk7XG4gIC8qKiDpobXpnaLkuK3ljIXlkKtgPHdlYi12aWV3PmDnu4Tku7bml7bvvIzov5Tlm57lvZPliY1gPHdlYi12aWV3PmDnmoR1cmxcbiAgICpcbiAgICog5pyA5L2O5Z+656GA5bqT77yaIGAxLjYuNGBcbiAgICovXG4gIHdlYlZpZXdVcmw/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBJQ3VzdG9tU2hhcmVDb250ZW50IHtcbiAgLyoqIOi9rOWPkeagh+mimOOAgum7mOiupOWAvO+8muW9k+WJjeWwj+eoi+W6j+WQjeensCAqL1xuICB0aXRsZT86IHN0cmluZztcbiAgLyoqIOi9rOWPkei3r+W+hO+8jOW/hemhu+aYr+S7pSAvIOW8gOWktOeahOWujOaVtOi3r+W+hOOAgum7mOiupOWAvO+8muW9k+WJjemhtemdoiBwYXRoICovXG4gIHBhdGg/OiBzdHJpbmc7XG4gIC8qKiDoh6rlrprkuYnlm77niYfot6/lvoTvvIzlj6/ku6XmmK/mnKzlnLDmlofku7bot6/lvoTjgIHku6PnoIHljIXmlofku7bot6/lvoTmiJbogIXnvZHnu5zlm77niYfot6/lvoTjgILmlK/mjIFQTkflj4pKUEfjgILmmL7npLrlm77niYfplb/lrr3mr5TmmK8gNTo077yM5pyA5L2O5Z+656GA5bqT77yaIGAxLjUuMGDjgILpu5jorqTlgLzvvJrkvb/nlKjpu5jorqTmiKrlm74gKi9cbiAgaW1hZ2VVcmw/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBDb21wb25lbnRPcHRpb24ge1xuICBba2V5OiBzdHJpbmddOiBhbnlcbn1cblxuaW50ZXJmYWNlIFBhZ2VPcHRpb24ge1xuICAgIFtrZXk6IHN0cmluZ106IGFueSxcbiAgICAvKiogXG4gICAgICog5L6d6LWWIHN0b3JlIOS4iueahCBwYXRoXG4gICAgICovXG4gICAgdXNlPzogQXJyYXk8c3RyaW5nIHwgb2JqZWN0PlxuICAgIC8qKiDnlJ/lkb3lkajmnJ/lm57osIPigJTnm5HlkKzpobXpnaLliqDovb1cbiAgICAgKlxuICAgICAqIOmhtemdouWKoOi9veaXtuinpuWPkeOAguS4gOS4qumhtemdouWPquS8muiwg+eUqOS4gOasoe+8jOWPr+S7peWcqCBvbkxvYWQg55qE5Y+C5pWw5Lit6I635Y+W5omT5byA5b2T5YmN6aG16Z2i6Lev5b6E5Lit55qE5Y+C5pWw44CCXG4gICAgICovXG4gICAgb25Mb2FkPyhcbiAgICAgIC8qKiDmiZPlvIDlvZPliY3pobXpnaLot6/lvoTkuK3nmoTlj4LmlbAgKi9cbiAgICAgIHF1ZXJ5PzogeyBbcXVlcnlLZXk6IHN0cmluZ106IHN0cmluZyB9LFxuICAgICk6IHZvaWQ7XG4gICAgLyoqIOeUn+WRveWRqOacn+Wbnuiwg+KAlOebkeWQrOmhtemdouaYvuekulxuICAgICAqXG4gICAgICog6aG16Z2i5pi+56S6L+WIh+WFpeWJjeWPsOaXtuinpuWPkeOAglxuICAgICAqL1xuICAgIG9uU2hvdz8oKTogdm9pZDtcbiAgICAvKiog55Sf5ZG95ZGo5pyf5Zue6LCD4oCU55uR5ZCs6aG16Z2i5Yid5qyh5riy5p+T5a6M5oiQXG4gICAgICogXG4gICAgICog6aG16Z2i5Yid5qyh5riy5p+T5a6M5oiQ5pe26Kem5Y+R44CC5LiA5Liq6aG16Z2i5Y+q5Lya6LCD55So5LiA5qyh77yM5Luj6KGo6aG16Z2i5bey57uP5YeG5aSH5aal5b2T77yM5Y+v5Lul5ZKM6KeG5Zu+5bGC6L+b6KGM5Lqk5LqS44CCXG4gICAgICogXG4gICBcbiAgICAgKiDms6jmhI/vvJrlr7nnlYzpnaLlhoXlrrnov5vooYzorr7nva7nmoQgQVBJIOWmgmB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGVg77yM6K+35ZyoYG9uUmVhZHlg5LmL5ZCO6L+b6KGM44CCXG4gICAgKi9cbiAgICBvblJlYWR5PygpOiB2b2lkO1xuICAgIC8qKiDnlJ/lkb3lkajmnJ/lm57osIPigJTnm5HlkKzpobXpnaLpmpDol49cbiAgICAgKlxuICAgICAqIOmhtemdoumakOiXjy/liIflhaXlkI7lj7Dml7bop6blj5HjgIIg5aaCIGBuYXZpZ2F0ZVRvYCDmiJblupXpg6ggYHRhYmAg5YiH5o2i5Yiw5YW25LuW6aG16Z2i77yM5bCP56iL5bqP5YiH5YWl5ZCO5Y+w562J44CCXG4gICAgICovXG4gICAgb25IaWRlPygpOiB2b2lkO1xuICAgIC8qKiDnlJ/lkb3lkajmnJ/lm57osIPigJTnm5HlkKzpobXpnaLljbjovb1cbiAgICAgKlxuICAgICAqIOmhtemdouWNuOi9veaXtuinpuWPkeOAguWmgmByZWRpcmVjdFRvYOaIlmBuYXZpZ2F0ZUJhY2tg5Yiw5YW25LuW6aG16Z2i5pe244CCXG4gICAgICovXG4gICAgb25VbmxvYWQ/KCk6IHZvaWQ7XG4gICAgLyoqIOebkeWQrOeUqOaIt+S4i+aLieWKqOS9nFxuICAgICAqXG4gICAgICog55uR5ZCs55So5oi35LiL5ouJ5Yi35paw5LqL5Lu244CCXG4gICAgICogLSDpnIDopoHlnKhgYXBwLmpzb25g55qEYHdpbmRvd2DpgInpobnkuK3miJbpobXpnaLphY3nva7kuK3lvIDlkK9gZW5hYmxlUHVsbERvd25SZWZyZXNoYOOAglxuICAgICAqIC0g5Y+v5Lul6YCa6L+HYHd4LnN0YXJ0UHVsbERvd25SZWZyZXNoYOinpuWPkeS4i+aLieWIt+aWsO+8jOiwg+eUqOWQjuinpuWPkeS4i+aLieWIt+aWsOWKqOeUu++8jOaViOaenOS4jueUqOaIt+aJi+WKqOS4i+aLieWIt+aWsOS4gOiHtOOAglxuICAgICAqIC0g5b2T5aSE55CG5a6M5pWw5o2u5Yi35paw5ZCO77yMYHd4LnN0b3BQdWxsRG93blJlZnJlc2hg5Y+v5Lul5YGc5q2i5b2T5YmN6aG16Z2i55qE5LiL5ouJ5Yi35paw44CCXG4gICAgICovXG4gICAgb25QdWxsRG93blJlZnJlc2g/KCk6IHZvaWQ7XG4gICAgLyoqIOmhtemdouS4iuaLieinpuW6leS6i+S7tueahOWkhOeQhuWHveaVsFxuICAgICAqXG4gICAgICog55uR5ZCs55So5oi35LiK5ouJ6Kem5bqV5LqL5Lu244CCXG4gICAgICogLSDlj6/ku6XlnKhgYXBwLmpzb25g55qEYHdpbmRvd2DpgInpobnkuK3miJbpobXpnaLphY3nva7kuK3orr7nva7op6blj5Hot53nprtgb25SZWFjaEJvdHRvbURpc3RhbmNlYOOAglxuICAgICAqIC0g5Zyo6Kem5Y+R6Led56a75YaF5ruR5Yqo5pyf6Ze077yM5pys5LqL5Lu25Y+q5Lya6KKr6Kem5Y+R5LiA5qyh44CCXG4gICAgICovXG4gICAgb25SZWFjaEJvdHRvbT8oKTogdm9pZDtcbiAgICAvKiog55So5oi354K55Ye75Y+z5LiK6KeS6L2s5Y+RXG4gICAgICpcbiAgICAgKiDnm5HlkKznlKjmiLfngrnlh7vpobXpnaLlhoXovazlj5HmjInpkq7vvIhgPGJ1dHRvbj5gIOe7hOS7tiBgb3Blbi10eXBlPVwic2hhcmVcImDvvInmiJblj7PkuIrop5Loj5zljZXigJzovazlj5HigJ3mjInpkq7nmoTooYzkuLrvvIzlubboh6rlrprkuYnovazlj5HlhoXlrrnjgIJcbiAgICAgKlxuICAgICAqICoq5rOo5oSP77ya5Y+q5pyJ5a6a5LmJ5LqG5q2k5LqL5Lu25aSE55CG5Ye95pWw77yM5Y+z5LiK6KeS6I+c5Y2V5omN5Lya5pi+56S64oCc6L2s5Y+R4oCd5oyJ6ZKuKipcbiAgICAgKlxuICAgICAqIOatpOS6i+S7tumcgOimgSByZXR1cm4g5LiA5LiqIE9iamVjdO+8jOeUqOS6juiHquWumuS5iei9rOWPkeWGheWuuVxuICAgICAqL1xuICAgIG9uU2hhcmVBcHBNZXNzYWdlPyhcbiAgICAgIC8qKiDliIbkuqvlj5HotbfmnaXmupDlj4LmlbAgKi9cbiAgICAgIG9wdGlvbnM/OiBJU2hhcmVBcHBNZXNzYWdlT3B0aW9uLFxuICAgICk6IElDdXN0b21TaGFyZUNvbnRlbnQ7XG4gICAgLyoqIOmhtemdoua7muWKqOinpuWPkeS6i+S7tueahOWkhOeQhuWHveaVsFxuICAgICAqXG4gICAgICog55uR5ZCs55So5oi35ruR5Yqo6aG16Z2i5LqL5Lu244CCXG4gICAgICovXG4gICAgb25QYWdlU2Nyb2xsPyhcbiAgICAgIC8qKiDpobXpnaLmu5rliqjlj4LmlbAgKi9cbiAgICAgIG9wdGlvbnM/OiBJUGFnZVNjcm9sbE9wdGlvbixcbiAgICApOiB2b2lkO1xuXG4gICAgLyoqIOW9k+WJjeaYryB0YWIg6aG15pe277yM54K55Ye7IHRhYiDml7bop6blj5HvvIzmnIDkvY7ln7rnoYDlupPvvJogYDEuOS4wYCAqL1xuICAgIG9uVGFiSXRlbVRhcD8oXG4gICAgICAvKiogdGFiIOeCueWHu+WPguaVsCAqL1xuICAgICAgb3B0aW9ucz86IElUYWJJdGVtVGFwT3B0aW9uLFxuICAgICk6IHZvaWQ7XG5cbiAgICAvKiog56qX5Y+j5bC65a+45pS55Y+Y5pe26Kem5Y+R77yM5pyA5L2O5Z+656GA5bqT77yaYDIuNC4wYCAqL1xuICAgIG9uUmVzaXplPyhcbiAgICAgIC8qKiDnqpflj6PlsLrlr7jlj4LmlbAgKi9cbiAgICAgIG9wdGlvbnM/OiBJUmVzaXplT3B0aW9uLFxuICAgICk6IHZvaWQ7XG59XG5cbmludGVyZmFjZSBJUmVzaXplT3B0aW9uIHtcbiAgc2l6ZToge1xuICAgIC8qKiDlj5jljJblkI7nmoTnqpflj6Plrr3luqbvvIzljZXkvY0gcHggKi9cbiAgICB3aW5kb3dXaWR0aDogbnVtYmVyO1xuICAgIC8qKiDlj5jljJblkI7nmoTnqpflj6Ppq5jluqbvvIzljZXkvY0gcHggKi9cbiAgICB3aW5kb3dIZWlnaHQ6IG51bWJlcjtcbiAgfTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlKHN0b3JlOiBhbnkgfCBDb21wb25lbnRPcHRpb24sIG9wdGlvbj86IFBhZ2VPcHRpb24pIHtcbiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHtcbiAgICBpZiAoIXN0b3JlLmluc3RhbmNlcykge1xuICAgICAgc3RvcmUuaW5zdGFuY2VzID0ge31cbiAgICB9XG5cbiAgICBpZighc3RvcmUub25DaGFuZ2Upe1xuICAgICAgc3RvcmUub25DaGFuZ2UgPSBmdW5jdGlvbihmbjogU3RvcmVDaGFuZ2VDYWxsYmFjayl7XG4gICAgICAgIGNoYW5nZXMucHVzaChmbilcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZighc3RvcmUub2ZmQ2hhbmdlKXtcbiAgICAgIHN0b3JlLm9mZkNoYW5nZSA9IGZ1bmN0aW9uKGZuOiBTdG9yZUNoYW5nZUNhbGxiYWNrKXtcbiAgICAgICAgZm9yKGxldCBpID0gMCxsZW4gPWNoYW5nZXMubGVuZ3RoO2k8bGVuO2krKyl7XG4gICAgICAgICAgaWYoY2hhbmdlc1tpXSA9PT0gZm4pe1xuICAgICAgICAgICAgY2hhbmdlcy5zcGxpY2UoaSwgMSlcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGdldEFwcCgpLmdsb2JhbERhdGEgJiYgKGdldEFwcCgpLmdsb2JhbERhdGEuc3RvcmUgPSBzdG9yZSlcbiAgIFxuICAgIG9wdGlvbi5kYXRhID0gc3RvcmUuZGF0YVxuICAgIG9ic2VydmVTdG9yZShzdG9yZSlcbiAgICBjb25zdCBvbkxvYWQgPSBvcHRpb24ub25Mb2FkXG5cbiAgICBvcHRpb24ub25Mb2FkID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgIHRoaXMuc3RvcmUgPSBzdG9yZVxuXG4gICAgICBvcHRpb24udXNlICYmICh0aGlzLl9fdXBkYXRlUGF0aCA9IGdldFBhdGgob3B0aW9uLnVzZSkpXG4gICAgICB0aGlzLl9fdXNlID0gb3B0aW9uLnVzZVxuICAgICAgc3RvcmUuaW5zdGFuY2VzW3RoaXMucm91dGVdID0gW11cbiAgICAgIHN0b3JlLmluc3RhbmNlc1t0aGlzLnJvdXRlXS5wdXNoKHRoaXMpXG4gICAgICBpZiAoIW9wdGlvbi5kYXRhLl9fX3dhbGtlZCkge1xuICAgICAgICB3YWxrKHRoaXMuc3RvcmUuZGF0YSlcbiAgICAgIH1cbiAgICAgIHRoaXMuc2V0RGF0YShvcHRpb24uZGF0YSlcbiAgICAgIGNvbnN0IHVzaW5nID0gZ2V0VXNpbmcoc3RvcmUuZGF0YSwgb3B0aW9uLnVzZSlcbiAgICAgIHVzaW5nICYmIHRoaXMuc2V0RGF0YSh1c2luZylcbiAgICAgIG9uTG9hZCAmJiBvbkxvYWQuY2FsbCh0aGlzLCBlKVxuICAgIH1cbiAgICBQYWdlKG9wdGlvbilcbiAgfSBlbHNlIHtcbiAgICBjb25zdCByZWFkeSA9IChzdG9yZS5saWZldGltZXMgJiYgc3RvcmUubGlmZXRpbWVzLnJlYWR5KSB8fCBzdG9yZS5yZWFkeVxuICAgIHN0b3JlLmxpZmV0aW1lcyA9IHN0b3JlLmxpZmV0aW1lcyB8fCB7fVxuICAgIHN0b3JlLnJlYWR5ID0gc3RvcmUubGlmZXRpbWVzLnJlYWR5ID0gZnVuY3Rpb24gKCkge1xuICAgICAgY29uc3QgcGFnZSA9IGdldEN1cnJlbnRQYWdlcygpW2dldEN1cnJlbnRQYWdlcygpLmxlbmd0aCAtIDFdXG4gICAgICBzdG9yZS51c2UgJiYgKHRoaXMuX191cGRhdGVQYXRoID0gZ2V0UGF0aChzdG9yZS51c2UpKVxuICAgICAgdGhpcy5zdG9yZSA9IHBhZ2Uuc3RvcmVcbiAgICAgIHRoaXMuX191c2UgPSBzdG9yZS51c2VcbiAgICAgIHN0b3JlLmRhdGEgPSB0aGlzLnN0b3JlLmRhdGFcbiAgICAgIHRoaXMuc2V0RGF0YShzdG9yZS5kYXRhKVxuICAgICAgY29uc3QgdXNpbmcgPSBnZXRVc2luZyh0aGlzLnN0b3JlLmRhdGEsIHN0b3JlLnVzZSlcbiAgICAgIHVzaW5nICYmIHRoaXMuc2V0RGF0YSh1c2luZylcbiAgICAgIHRoaXMuc3RvcmUuaW5zdGFuY2VzW3BhZ2Uucm91dGVdLnB1c2godGhpcylcbiAgICAgIHJlYWR5ICYmIHJlYWR5LmNhbGwodGhpcylcbiAgICB9XG4gICAgQ29tcG9uZW50KHN0b3JlKVxuICB9XG59XG5cblxuZnVuY3Rpb24gb2JzZXJ2ZVN0b3JlKHN0b3JlKSB7XG4gIG9iYWEoc3RvcmUuZGF0YSwgKHByb3AsIHZhbHVlLCBvbGQsIHBhdGgpID0+IHtcbiAgICBsZXQgcGF0Y2ggPSB7fVxuICAgIGlmIChwcm9wLmluZGV4T2YoJ0FycmF5LXB1c2gnKSA9PT0gMCkge1xuICAgICAgbGV0IGRsID0gdmFsdWUubGVuZ3RoIC0gb2xkLmxlbmd0aFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkbDsgaSsrKSB7XG4gICAgICAgIHBhdGNoWyBmaXhQYXRoKHBhdGggKyAnLScgKyAob2xkLmxlbmd0aCArIGkpKV0gPSB2YWx1ZVsob2xkLmxlbmd0aCArIGkpXVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocHJvcC5pbmRleE9mKCdBcnJheS0nKSA9PT0gMCkge1xuICAgICAgcGF0Y2hbIGZpeFBhdGgocGF0aCldID0gdmFsdWVcbiAgICB9IGVsc2Uge1xuICAgICAgcGF0Y2hbIGZpeFBhdGgocGF0aCArICctJyArIHByb3ApXSA9IHZhbHVlXG4gICAgfVxuXG4gICAgX3VwZGF0ZShwYXRjaCwgc3RvcmUpXG4gICAgXG4gICAgXG4gIH0pXG59XG5cbmZ1bmN0aW9uIF91cGRhdGUoa3YsIHN0b3JlKSB7XG4gIGZvciAobGV0IGtleSBpbiBzdG9yZS5pbnN0YW5jZXMpIHtcbiAgICBzdG9yZS5pbnN0YW5jZXNba2V5XS5mb3JFYWNoKGlucyA9PiB7XG4gICAgICBpZihzdG9yZS51cGRhdGVBbGwgfHwgaW5zLl9fdXBkYXRlUGF0aCAmJiBuZWVkVXBkYXRlKGt2LGlucy5fX3VwZGF0ZVBhdGgpKXtcbiAgICAgICAgaW5zLnNldERhdGEuY2FsbChpbnMsIGt2KVxuXG4gICAgICAgIGNvbnN0IHVzaW5nID0gZ2V0VXNpbmcoc3RvcmUuZGF0YSwgaW5zLl9fdXNlKVxuICAgICAgICB1c2luZyAmJiBpbnMuc2V0RGF0YSh1c2luZylcblxuICAgICAgICAvL+WNs+WwhuW6n+W8g1xuICAgICAgICB1cGRhdGVTdG9yZUJ5Rm5Qcm9wKGlucywgc3RvcmUuZGF0YSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG4gIGNoYW5nZXMuZm9yRWFjaChjaGFuZ2UgPT4ge1xuICAgIGNoYW5nZShrdilcbiAgfSlcbiAgc3RvcmUuZGVidWcgJiYgc3RvcmVDaGFuZ2VMb2dnZXIoc3RvcmUsIGt2KVxufVxuXG5mdW5jdGlvbiBzdG9yZUNoYW5nZUxvZ2dlciAoc3RvcmUsIGRpZmZSZXN1bHQpIHtcbiAgdHJ5IHtcbiAgICAgIGNvbnN0IHByZVN0YXRlID0gd3guZ2V0U3RvcmFnZVN5bmMoYEN1cnJlbnRTdGF0ZWApIHx8IHt9XG4gICAgICBjb25zdCB0aXRsZSA9IGBTdGF0ZSBDaGFuZ2VkYFxuICAgICAgY29uc29sZS5ncm91cENvbGxhcHNlZChgJWMgICR7IHRpdGxlIH0gJWMgJHsgT2JqZWN0LmtleXMoZGlmZlJlc3VsdCkgfWAsICdjb2xvcjojZTBjMTg0OyBmb250LXdlaWdodDogYm9sZCcsICdjb2xvcjojZjBhMTM5OyBmb250LXdlaWdodDogYm9sZCcpXG4gICAgICBjb25zb2xlLmxvZyhgJWMgICAgUHJlIFN0YXRlYCwgJ2NvbG9yOiNmZjY1YWY7IGZvbnQtd2VpZ2h0OiBib2xkJywgcHJlU3RhdGUpXG4gICAgICBjb25zb2xlLmxvZyhgJWMgQ2hhbmdlIFN0YXRlYCwgJ2NvbG9yOiMzZDkxY2Y7IGZvbnQtd2VpZ2h0OiBib2xkJywgZGlmZlJlc3VsdClcbiAgICAgIGNvbnNvbGUubG9nKGAlYyAgIE5leHQgU3RhdGVgLCAnY29sb3I6IzJjOWY2NzsgZm9udC13ZWlnaHQ6IGJvbGQnLCBzdG9yZS5kYXRhKVxuICAgICAgY29uc29sZS5ncm91cEVuZCgpXG4gICAgICB3eC5zZXRTdG9yYWdlU3luYyhgQ3VycmVudFN0YXRlYCwgc3RvcmUuZGF0YSlcbiAgfSBjYXRjaCAoZSkge1xuICAgICAgY29uc29sZS5sb2coZSlcbiAgfVxuICAgIFxufVxuXG5mdW5jdGlvbiB1cGRhdGVTdG9yZUJ5Rm5Qcm9wKGVsZSwgZGF0YSkge1xuICBpZihkYXRhKXtcbiAgICBsZXQgcGF0Y2ggPSB7fVxuICAgIGZvciAobGV0IGtleSBpbiBkYXRhLl9fZm5NYXBwaW5nKSB7XG4gICAgICBwYXRjaFtrZXldID0gZGF0YS5fX2ZuTWFwcGluZ1trZXldLmNhbGwoZGF0YSlcbiAgICB9XG4gICAgZWxlLnNldERhdGEocGF0Y2gpXG4gIH1cbn1cblxuXG5cbmZ1bmN0aW9uIGdldE9iakJ5UGF0aChwYXRoLCBkYXRhKSB7XG4gIGNvbnN0IGFyciA9IHBhdGgucmVwbGFjZSgvXS9nLCAnJykucmVwbGFjZSgvXFxbL2csICcuJykuc3BsaXQoJy4nKVxuICBjb25zdCBsZW4gPSBhcnIubGVuZ3RoXG4gIGlmIChsZW4gPiAxKSB7XG4gICAgbGV0IGN1cnJlbnQgPSBkYXRhW2FyclswXV1cbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGxlbiAtIDE7IGkrKykge1xuICAgICAgY3VycmVudCA9IGN1cnJlbnRbYXJyW2ldXVxuICAgIH1cbiAgICByZXR1cm4geyBvYmo6IGN1cnJlbnQsIGtleTogYXJyW2xlbiAtIDFdIH1cbiAgfSBlbHNlIHtcbiAgICByZXR1cm4geyBvYmo6IGRhdGEsIGtleTogYXJyWzBdIH1cbiAgfVxufVxuXG5mdW5jdGlvbiB3YWxrKGRhdGEpIHtcbiAgLy9fX193YWxrZWQg55So5LqO5qCH6K6w5piv5ZCm5bey57uP6KeC5a+f6YGN5Y6G5LqGXG4gIGRhdGEuX19fd2Fsa2VkID0gdHJ1ZVxuICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgY29uc3Qgb2JqID0gZGF0YVtrZXldXG4gICAgY29uc3QgdHAgPSB0eXBlKG9iailcbiAgICBpZiAodHAgPT0gRlVOQ1RJT05UWVBFKSB7XG4gICAgICBzZXRQcm9wKGtleSwgb2JqLCBkYXRhKVxuICAgIH0gZWxzZSBpZiAodHAgPT0gT0JKRUNUVFlQRSkge1xuICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKHN1YktleSA9PiB7XG4gICAgICAgIF93YWxrKG9ialtzdWJLZXldLCBrZXkgKyAnLicgKyBzdWJLZXksIGRhdGEpXG4gICAgICB9KVxuXG4gICAgfSBlbHNlIGlmICh0cCA9PSBBUlJBWVRZUEUpIHtcbiAgICAgIG9iai5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuICAgICAgICBfd2FsayhpdGVtLCBrZXkgKyAnWycgKyBpbmRleCArICddJywgZGF0YSlcbiAgICAgIH0pXG5cbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIF93YWxrKG9iaiwgcGF0aCwgZGF0YSkge1xuICBjb25zdCB0cCA9IHR5cGUob2JqKVxuICBpZiAodHAgPT0gRlVOQ1RJT05UWVBFKSB7XG4gICAgc2V0UHJvcChwYXRoLCBvYmosIGRhdGEpXG4gIH0gZWxzZSBpZiAodHAgPT0gT0JKRUNUVFlQRSkge1xuICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaChzdWJLZXkgPT4ge1xuICAgICAgX3dhbGsob2JqW3N1YktleV0sIHBhdGggKyAnLicgKyBzdWJLZXksIGRhdGEpXG4gICAgfSlcblxuICB9IGVsc2UgaWYgKHRwID09IEFSUkFZVFlQRSkge1xuICAgIG9iai5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuICAgICAgX3dhbGsoaXRlbSwgcGF0aCArICdbJyArIGluZGV4ICsgJ10nLCBkYXRhKVxuICAgIH0pXG5cbiAgfVxufVxuXG5mdW5jdGlvbiBzZXRQcm9wKHBhdGgsIGZuLCBkYXRhKSB7XG4gIGNvbnN0IG9rID0gZ2V0T2JqQnlQYXRoKHBhdGgsIGRhdGEpXG5cbiAgZGF0YS5fX2ZuTWFwcGluZyA9IGRhdGEuX19mbk1hcHBpbmcgfHwge31cbiAgZGF0YS5fX2ZuTWFwcGluZ1twYXRoXSA9IGZuXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvay5vYmosIG9rLmtleSwge1xuICAgIGVudW1lcmFibGU6IHRydWUsXG4gICAgZ2V0OiAoKSA9PiB7XG4gICAgICByZXR1cm4gZm4uY2FsbChvay5vYmopXG4gICAgfSxcbiAgICBzZXQ6ICgpID0+IHtcbiAgICAgIGNvbnNvbGUud2FybignUGxlYXNlIHVzaW5nIHRoaXMuZGF0YS5tZXRob2QgdG8gc2V0IG1ldGhvZCBwcm9wIG9mIGRhdGEhJylcbiAgICB9XG4gIH0pXG4gIFxuXG59XG5cbmZ1bmN0aW9uIHR5cGUob2JqKSB7XG4gIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKVxufVxuXG5cblxuXG5cblxuXG5mdW5jdGlvbiB1cGRhdGVCeUZuUHJvcChlbGUsIGRhdGEpIHtcbiAgbGV0IHBhdGNoID0ge31cbiAgZm9yIChsZXQga2V5IGluIGRhdGEuX19mbk1hcHBpbmcpIHtcbiAgICBwYXRjaFtrZXldID0gZGF0YS5fX2ZuTWFwcGluZ1trZXldLmNhbGwoZWxlLm9EYXRhKVxuICB9XG4gIGVsZS5zZXREYXRhKHBhdGNoKVxufVxuXG5cbmNyZWF0ZS5vYmFhID0gb2JhYVxuXG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZVxuIl19